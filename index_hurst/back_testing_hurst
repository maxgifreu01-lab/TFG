# region imports
from AlgorithmImports import *
import numpy as np
# endregion


class HurstStrategy(QCAlgorithm):

    def Initialize(self):
        self.SetStartDate(2020, 1, 1)
        self.SetEndDate(2024, 1, 1)
        self.SetCash(100000)

        self.ticker = "AAPL"
        self.symbol = self.AddEquity(self.ticker, Resolution.Daily).Symbol

        self.lookback = 100
        self.window = RollingWindow[float](self.lookback)

        self.h_up = 0.55
        self.h_down = 0.45

        self.SetWarmUp(self.lookback)

    def OnData(self, data: Slice):
        if self.IsWarmingUp:
            return

        if not data.ContainsKey(self.symbol) or data[self.symbol] is None:
            return

        price = float(data[self.symbol].Close)
        self.window.Add(price)

        if not self.window.IsReady:
            return

        prices = np.array(
            [self.window[i] for i in range(self.window.Count)],
            dtype=float
        )[::-1]

        H = self.CalculateHurst(prices)

        if H > self.h_up and not self.Portfolio.Invested:
            self.SetHoldings(self.symbol, 1.0)

        elif H < self.h_down and self.Portfolio.Invested:
            self.Liquidate(self.symbol)

    def CalculateHurst(self, ts: np.ndarray) -> float:
        lags = range(2, 20)
        tau = [np.std(ts[lag:] - ts[:-lag]) for lag in lags]
        poly = np.polyfit(np.log(list(lags)), np.log(tau), 1)
        return float(poly[0] * 2.0)